name: Deploy Modified Files to Snowflake PROD env..........

# Triggers ONLY on a push to the main branch
on:
  push:
    branches:
      - main

jobs:
  deploy-snowflake-changes:
    runs-on: ubuntu-latest
    env:
      SNOWFLAKE_CONNECTION: default
      SNOWFLAKE_CONNECTIONS_DEFAULT_AUTHENTICATOR: "SNOWFLAKE_JWT"
      SNOWFLAKE_CONNECTIONS_DEFAULT_PRIVATE_KEY_FILE: ".snowflake/rsa_key.pem"
      SNOWFLAKE_CONNECTIONS_DEFAULT_ACCOUNT: ${{ secrets.SNOWFLAKE_ACCOUNT }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_USER: ${{ secrets.SNOWFLAKE_USER }}
      SNOWFLAKE_CONNECTIONS_DEFAULT_WAREHOUSE: COMPUTE_WH
      SNOWFLAKE_CONNECTIONS_DEFAULT_ROLE: ACCOUNTADMIN
      SNOWFLAKE_CONNECTIONS_DEFAULT_DATABASE: CICD_DEMO_DB
      SNOWFLAKE_CONNECTIONS_DEFAULT_SCHEMA: TECH

    steps:
      # Check out the repository's code.
      # fetch-depth: 0 - get all commit history for the git diff command.
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # Install Snowflake CLI so `snow` is available on PATH
      - name: Install snowflake-cli
        uses: Snowflake-Labs/snowflake-cli-action@v1.5
        with:
          cli-version: "latest"
          # default-config-file-path: ".snowflake/config_incremental.toml"  

      # Write private key secret as file (ensure SnowCLI can read it)
      - name: Configure Private Key
        run: |
          mkdir -p .snowflake
          echo "${{ secrets.SNOWFLAKE_PRIVATE_KEY }}" > .snowflake/rsa_key.pem
          chmod 600 .snowflake/rsa_key.pem

      - name: Test Basic Snowflake Connection
        run: |
          echo "ðŸ”— Testing basic Snowflake connection..."
          if snow connection test; then
            echo "âœ… Basic connection test passed"
          else
            echo "âŒ Basic connection test failed"
            exit 1
          fi

      - name: Run Customer.sql
        run: |
          snow sql -f "Snowflake/01_Table/Customer.sql"

      - name: Find and Deploy Modified SQL Files
        run: |
          echo "Identifying changed files..."
          BEFORE_SHA="${{ github.event.before }}"
          CURRENT_SHA="${{ github.sha }}"

          # Fallback for first push/branch where BEFORE_SHA may be empty or all zeros
          if [ -z "$BEFORE_SHA" ] || [ "$BEFORE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "No valid before SHA; deriving base from main."
            git fetch origin main || true
            BASE=$(git merge-base HEAD origin/main || echo "")
            BEFORE_SHA="${BASE:-$(git rev-list --max-parents=0 HEAD | tail -n 1)}"
          fi

          CHANGED_FILES=$(git diff --name-only "$BEFORE_SHA" "$CURRENT_SHA" -- 'Snowflake/**/*.sql' || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "No modified SQL files found in this push."
            exit 0
          fi

          FILES_TO_DEPLOY=$(echo "$CHANGED_FILES" | sort)
          echo "The following files will be deployed in this order:"
          echo "$FILES_TO_DEPLOY"

          OVERALL_STATUS=0

          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            echo "--------------------------------------------------"
            echo "Executing: $FILE"
            if snow sql -f "$FILE" --temporary-connection > output.log 2>&1; then
              STATUS="SUCCESS"
              ERROR_MSG=""
              echo "Successfully executed $FILE"
            else
              STATUS="FAILED"
              ERROR_MSG=$(sed "s/'/''/g" < output.log)
              echo "Execution of $FILE failed with error:"
              echo "$ERROR_MSG"
              OVERALL_STATUS=1
            fi
            LOG_QUERY="INSERT INTO CICD_DEMO_DB.TECH.DEPLOYMENT_HISTORY (FILENAME, COMMIT_SHA, GITHUB_ACTOR, STATUS, ERROR_MESSAGE) VALUES ('$FILE', '${{ github.sha }}', '${{ github.actor }}', '$STATUS', '$ERROR_MSG');"
            snow sql -q "$LOG_QUERY" --temporary-connection
            echo "Logged deployment for $FILE with status: $STATUS"
            echo "--------------------------------------------------"
          done <<< "$FILES_TO_DEPLOY"

          if [ $OVERALL_STATUS -ne 0 ]; then
            echo "One or more SQL scripts failed. Failing the workflow."
            exit 1
          fi
